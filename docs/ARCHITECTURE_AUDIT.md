# –ê—É–¥–∏—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã Art Style Attribution Lab

**–î–∞—Ç–∞:** –Ø–Ω–≤–∞—Ä—å 2025  
**–¶–µ–ª—å:** –í—ã—è–≤–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –∏ –∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

---

## üìê –°–ª–æ–∏ –ø—Ä–æ–µ–∫—Ç–∞

### 1. ML Layer (`ml/`)
**–†–æ–ª—å:** TensorFlow multi-head CNN –Ω–∞ –±–∞–∑–µ MobileNetV2 –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤, –∂–∞–Ω—Ä–æ–≤ –∏ —Å—Ç–∏–ª–µ–π.

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `predict_artists.py` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π inference –º–æ–¥—É–ª—å
- `models/wikiart_mobilenetv2_multihead.keras` ‚Äî –æ–±—É—á–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å
- `models/class_labels.json` ‚Äî –º–µ—Ç–∫–∏ –∫–ª–∞—Å—Å–æ–≤

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω, –±–µ–∑ –ø—Ä–æ–±–ª–µ–º

---

### 2. Backend Layer (`backend/`)

#### 2.1 Core (`app/core/`)
| –§–∞–π–ª | –†–æ–ª—å | –°—Ç–∞—Ç—É—Å |
|------|------|--------|
| `config.py` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Pydantic | ‚úÖ –ß–∏—Å—Ç–æ |
| `database.py` | SQLAlchemy —Å–µ—Å—Å–∏—è | ‚úÖ –ß–∏—Å—Ç–æ |
| `security.py` | JWT —É—Ç–∏–ª–∏—Ç—ã | ‚úÖ –ß–∏—Å—Ç–æ |
| `file_validator.py` | –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–æ–∫ | ‚úÖ –ß–∏—Å—Ç–æ |
| `rate_limiter.py` | Rate limiting | üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |

#### 2.2 API (`app/api/`)
| –§–∞–π–ª | –†–æ–ª—å | –°—Ç–∞—Ç—É—Å |
|------|------|--------|
| `analyze.py` | SSE —Å—Ç—Ä–∏–º–∏–Ω–≥ –∞–Ω–∞–ª–∏–∑–∞ | ‚úÖ –ß–∏—Å—Ç–æ |
| `deep_analysis.py` | –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ | üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| `auth.py` | –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è | ‚úÖ –ß–∏—Å—Ç–æ |
| `history.py` | –ò—Å—Ç–æ—Ä–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤ | ‚úÖ –ß–∏—Å—Ç–æ |
| `deps.py` | –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ DI | ‚úÖ –ß–∏—Å—Ç–æ |

#### 2.3 Services (`app/services/`)
| –§–∞–π–ª | –†–æ–ª—å | –°—Ç–∞—Ç—É—Å |
|------|------|--------|
| `classifier.py` | –û–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ ML | ‚úÖ –ß–∏—Å—Ç–æ |
| `llm_client.py` | –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ | ‚úÖ –ß–∏—Å—Ç–æ |
| `llm_service.py` | LLM –æ–±—ä—è—Å–Ω–µ–Ω–∏—è | ‚úÖ –ß–∏—Å—Ç–æ |
| `comfyui_service.py` | ComfyUI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è | ‚úÖ –ß–∏—Å—Ç–æ |
| `deep_analysis_service.py` | CV + LLM –∞–Ω–∞–ª–∏–∑ | üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (retry) |
| `prompts.py` | –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã | ‚úÖ –ß–∏—Å—Ç–æ |

---

### 3. Frontend Layer (`frontend/`)

#### 3.1 Core
| –§–∞–π–ª | –†–æ–ª—å | –°—Ç–∞—Ç—É—Å |
|------|------|--------|
| `src/api/index.js` | Axios –∫–ª–∏–µ–Ω—Ç | üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| `src/pages/Analyze.jsx` | –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ | ‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª |
| `src/context/AuthContext.jsx` | Auth state | ‚úÖ –ß–∏—Å—Ç–æ |
| `src/context/ThemeContext.jsx` | –¢–µ–º–∞ | ‚úÖ –ß–∏—Å—Ç–æ |

---

## üêõ –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ë–∞–≥ 1: –°–ª–∏—à–∫–æ–º –∂—ë—Å—Ç–∫–∏–π Rate Limiter
**–°–∏–º–ø—Ç–æ–º:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç 429 –∏ –¥–æ–ª–∂–µ–Ω –∂–¥–∞—Ç—å —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ.

**–ü—Ä–∏—á–∏–Ω–∞:**
- –õ–∏–º–∏—Ç—ã –±—ã–ª–∏ —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–º–∏ (10 req/min –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞, 3 –¥–ª—è deep analysis)
- –ù–µ –±—ã–ª–æ `Retry-After` header –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–≤–µ–ª–∏—á–µ–Ω—ã –ª–∏–º–∏—Ç—ã: `/api/analyze` ‚Üí 15, `/api/deep-analysis/full` ‚Üí 5
2. –î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å `RateLimitExceeded` —Å `Retry-After` header
3. Frontend —Ç–µ–ø–µ—Ä—å –ø–∞—Ä—Å–∏—Ç `Retry-After` –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

**–§–∞–π–ª—ã:**
- `backend/app/core/rate_limiter.py` ‚úÖ
- `frontend/src/api/index.js` ‚úÖ

---

### –ë–∞–≥ 2: –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥—É—é—â–∏–π –∞–Ω–∞–ª–∏–∑
**–°–∏–º–ø—Ç–æ–º:** –ü–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–ª–∏ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è.

**–ü—Ä–∏—á–∏–Ω–∞:**
- SSE stream –º–æ–≥ –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è –±–µ–∑ —Å–æ–±—ã—Ç–∏—è `complete` –∏–ª–∏ `error`
- Frontend –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–ª —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ

**–†–µ—à–µ–Ω–∏–µ:**
1. –î–æ–±–∞–≤–ª–µ–Ω fallback –≤ `analyzeStream` ‚Äî –µ—Å–ª–∏ stream –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –±–µ–∑ —Å–æ–±—ã—Ç–∏—è, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `onComplete` –∏–ª–∏ `onError`
2. –¢—Ä–µ–∫–∏–Ω–≥ `receivedComplete`, `receivedError`, `receivedPredictions` –¥–ª—è graceful handling

**–§–∞–π–ª—ã:**
- `frontend/src/api/index.js` ‚úÖ

---

### –ë–∞–≥ 3: "–û—à–∏–±–∫–∞ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞" –±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã
**–°–∏–º–ø—Ç–æ–º:** Deep analysis –∏–Ω–æ–≥–¥–∞ –ø–∞–¥–∞–µ—Ç –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è.

**–ü—Ä–∏—á–∏–Ω–∞:**
- `LLM_TIMEOUT` –±—ã–ª 120 —Å–µ–∫—É–Ω–¥, –Ω–æ Ollama –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ
- –ù–µ—Ç retry –ª–æ–≥–∏–∫–∏ –¥–ª—è LLM –≤—ã–∑–æ–≤–æ–≤
- –ù–µ–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–≤–µ–ª–∏—á–µ–Ω `LLM_TIMEOUT` –¥–æ 180 —Å–µ–∫—É–Ω–¥
2. –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `retry_llm_call()` —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff (1 retry, delay 3s)
3. –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `_llm_generate_with_retry()`
4. –£–ª—É—á—à–µ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –≤ `deep_analysis.py` ‚Äî —Ç–µ–ø–µ—Ä—å —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è timeout, connection, LLM errors

**–§–∞–π–ª—ã:**
- `backend/app/core/config.py` ‚úÖ
- `backend/app/services/deep_analysis_service.py` ‚úÖ
- `backend/app/api/deep_analysis.py` ‚úÖ

---

## ‚ö†Ô∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ)

### 1. –ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π Analyze.jsx (1566 —Å—Ç—Ä–æ–∫)
**–ü—Ä–æ–±–ª–µ–º–∞:** –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π, —Å–æ–¥–µ—Ä–∂–∏—Ç:
- –í—Å–µ —Ö–µ–ª–ø–µ—Ä—ã (`cleanThinkTags`, `hasThinkingInProgress`)
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (`BlockedOverlay`, `InlineMarker`, `RichTextWithMarkers`)
- –í—Å—é –ª–æ–≥–∏–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –†–∞–∑–±–∏—Ç—å –Ω–∞ –º–æ–¥—É–ª–∏:
```
src/
  components/
    analysis/
      BlockedOverlay.jsx
      InlineMarker.jsx
      RichTextWithMarkers.jsx
      DeepAnalysisSection.jsx
      GenerationSection.jsx
  hooks/
    useStreamingAnalysis.js
    useDeepAnalysis.js
    useCollaborativeSession.js
  utils/
    thinkTagsCleaner.js
```

### 2. –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –Ω–∞ Frontend
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–∞–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ–∑–¥–∞—Ç—å `useErrorHandler` hook –∏–ª–∏ Error Boundary.

### 3. –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ CV –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ async context
**–§–∞–π–ª:** `deep_analysis_service.py`

**–ü—Ä–æ–±–ª–µ–º–∞:** `extract_color_features()`, `extract_composition_features()` ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ, –±–ª–æ–∫–∏—Ä—É—é—Ç event loop.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `asyncio.to_thread()`:
```python
color_features = await asyncio.to_thread(extract_color_features, image_path)
```

### 4. –ù–µ—Ç health check endpoint
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å `/api/health` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π:
- Database connection
- Ollama availability
- ComfyUI availability

---

## üìä –°–≤–æ–¥–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –§–∞–π–ª | –¢–∏–ø –∏–∑–º–µ–Ω–µ–Ω–∏—è |
|------|---------------|
| `rate_limiter.py` | –£–≤–µ–ª–∏—á–µ–Ω—ã –ª–∏–º–∏—Ç—ã, –¥–æ–±–∞–≤–ª–µ–Ω Retry-After |
| `api/index.js` | –û–±—Ä–∞–±–æ—Ç–∫–∞ 429, fallback –¥–ª—è SSE |
| `config.py` | LLM_TIMEOUT ‚Üí 180 |
| `deep_analysis_service.py` | –î–æ–±–∞–≤–ª–µ–Ω retry helper |
| `deep_analysis.py` | –£–ª—É—á—à–µ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö |

---

## ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

1. **Rate Limiting:**
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å 16 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–¥—Ä—è–¥ –Ω–∞ `/api/analyze`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ 16-–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 429 —Å `Retry-After` header

2. **SSE Stream Recovery:**
   - –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ ‚Üí –ø—Ä–µ—Ä–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ ‚Üí –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
   - UI –¥–æ–ª–∂–µ–Ω —Å–±—Ä–æ—Å–∏—Ç—å—Å—è –∏ –ø–æ–∑–≤–æ–ª–∏—Ç—å –Ω–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑

3. **Deep Analysis Stability:**
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å deep analysis 5 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥
   - –ü—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
